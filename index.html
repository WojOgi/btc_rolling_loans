<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bitcoin Rolling Loan Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f9f9f9;color:#222}
    h2{margin-top:0}
    label{display:block;margin-top:10px}
    input{padding:4px;margin-top:4px;width:140px}
    button{margin-top:12px;padding:6px 14px;background:#ff9900;border:none;color:#fff;border-radius:4px;cursor:pointer}
    button:hover{background:#cc7a00}
    table{border-collapse:collapse;margin-top:20px;width:100%;background:#fff}
    th,td{border:1px solid #ccc;padding:6px;text-align:right}
    th{background:#eee;text-align:center}
    #chart-container{margin-top:30px;width:100%}
    canvas{max-width:100%;height:600px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>Bitcoin Rolling Loan Simulator</h2>
<div id="form">
  <label>Collateral (BTC):
    <input type="number" id="collateral" value="0.5" min="0" step="0.01">
  </label>
  <label>Initial Annual Draw (USD):
    <input type="number" id="draw" value="24000" min="0">
  </label>
  <label>Draw Increase per Year (% inflation):
    <input type="number" id="drawInc" value="5" min="0" step="0.1">
  </label>
  <label>Delay Before First Draw (years):
    <input type="number" id="delay" value="5" min="0">
  </label>
  <label>Interest Rate (% APR):
    <input type="number" id="rate" value="12.5" min="0" step="0.1">
  </label>
  <label>Starting CAGR (%):
    <input type="number" id="cagr" value="45" min="0" step="0.1">
  </label>
  <label>CAGR Reduction per Year (%):
    <input type="number" id="decay" value="5" min="0" step="0.1">
  </label>
  <label>Simulation Years:
    <input type="number" id="years" value="20" min="1">
  </label>
  <button id="run">Simulate</button>
</div>

<div id="priceDiv"></div>
<div id="tableDiv"></div>
<div id="chart-container"><canvas id="chart"></canvas></div>

<script>
async function getBTCPrice(){try{const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');const d=await r.json();return d.bitcoin.usd}catch(e){alert('Price fetch failed, defaulting to 120,000');return 120000}}
function fmt(n){return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}
let chartInstance=null;

document.getElementById('run').addEventListener('click',async()=>{
  const collateralBTC=parseFloat(document.getElementById('collateral').value);
  const initialDraw=parseFloat(document.getElementById('draw').value);
  const drawInc=parseFloat(document.getElementById('drawInc').value)/100;
  const delay=parseInt(document.getElementById('delay').value,10);
  const rate=parseFloat(document.getElementById('rate').value)/100;
  const startCagr=parseFloat(document.getElementById('cagr').value)/100;
  const decay=parseFloat(document.getElementById('decay').value)/100;
  const years=parseInt(document.getElementById('years').value,10);

  const startPrice=await getBTCPrice();
  document.getElementById('priceDiv').innerHTML=`<p><strong>Current BTC Price:</strong> $${fmt(startPrice)}</p>`;

  let btcPrice=startPrice;
  let loan=0;
  let cagr=startCagr;
  let rows='';
  const labels=[];
  const collateralArr=[];
  const ltvArr=[];
  const loanArr=[];

  for(let y=1;y<=years;y++){
    const collateralValue=btcPrice*collateralBTC;
    let draw=0;
    let interest=0;
    if(y>delay){
      const yearsSinceFirst=y-delay-1;
      draw=initialDraw*Math.pow(1+drawInc,yearsSinceFirst);
      loan+=draw;
      interest=loan*rate;
      loan+=interest;
    }

    rows+=`<tr><td>${y}</td><td>$${fmt(btcPrice)}</td><td>$${fmt(collateralValue)}</td><td>$${fmt(draw)}</td><td>$${fmt(loan)}</td><td>$${fmt(interest)}</td><td>${fmt(loan/collateralValue*100)}%</td></tr>`;

    labels.push(`Year ${y}`);
    collateralArr.push(collateralValue);
    loanArr.push(loan);
    ltvArr.push((loan/collateralValue)*100);

    btcPrice*=(1+cagr);
    cagr*=(1-decay);
  }

  document.getElementById('tableDiv').innerHTML=`<table><thead><tr><th>Year</th><th>BTC Price</th><th>Collateral Value</th><th>Draw</th><th>Loan Balance End</th><th>Interest Added</th><th>LTV</th></tr></thead><tbody>${rows}</tbody></table>`;

  const ctx=document.getElementById('chart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Collateral Value (USD)',data:collateralArr,yAxisID:'y1',borderWidth:2,fill:false},{label:'Loan Balance (USD)',data:loanArr,yAxisID:'y1',borderWidth:2,fill:false,borderDash:[5,5]},{label:'LTV (%)',data:ltvArr,yAxisID:'y2',borderWidth:2,fill:false}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},scales:{y1:{type:'linear',position:'left',title:{display:true,text:'USD Values'}},y2:{type:'linear',position:'right',title:{display:true,text:'LTV (%)'},grid:{drawOnChartArea:false}}}}});
});
</script>
</body>
</html>
